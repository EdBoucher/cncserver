<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
    <script src="/jquery/jquery.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/paper/paper-full.min.js"></script>
    <script src="/axios/axios.min.js"></script>
    <script src="/lib/cncserver.client.api.js"></script>
    <script src="/lib/cncserver.client.commander.js"></script>
    <link rel="stylesheet" href="/font-awesome/fontawesome.min.css">
    <link rel="stylesheet" href="/font-awesome/solid.min.css">
    <link rel="stylesheet" href="/font-awesome/brands.min.css">
    <link rel="stylesheet" href="/bulma/bulma.min.css">
    <link rel="stylesheet" href="/styles/interface.css">
  </head>
  <title>CNC Server client</title>
<body>
  <section class="hero is-dark is-bold">
    <div class="hero-body">
      <div class="container">
        <figure class="image is-128x128 logo">
          <img src="icon.png">
        </figure>

        <h1 class="title">CNC Server client v3.0-beta1</h1>
        <p class="subtitle"></p>
      </div>
    </div>
  </section>
  <div class="section columns is-multiline">
    <section class="column is-half">
      <div class="tabs is-boxed">
        <ul>
          <li class="is-active" data-tab="1"><a>
            <span class="icon is-small"><i class="fas fa-vial" aria-hidden="true"></i></span>
            <span>Basic</span>
          </a></li>
          <li data-tab="2"><a>
            <span class="icon is-small"><i class="fas fa-vials" aria-hidden="true"></i></span>
            <span>Advanced</span>
          </a></li>
          <li data-tab="3"><a>
            <span class="icon is-small"><i class="fas fa-cogs" aria-hidden="true"></i></span>
            <span>Settings</span>
          </a></li>
          <li data-tab="4"><a>
            <span class="icon is-small"><i class="fas fa-tasks" aria-hidden="true"></i></span>
            <span>Diagnostics</span>
          </a></li>
        </ul>
      </div>
      <div class="tabs-content">
        <div class="tab-content is-active" data-content="1"><!-- Basic -->

          <label class="label">
            <span class="icon"><i class="fas fa-toolbox" aria-hidden="true"></i></span>
            <span>Tools:</span>
          </label>
          <div class="field is-grouped" id="tools">
            <h4>Loading tool set...</h4>
          </div>

          <fieldset>
            <legend>General</legend>
            <a class="button is-primary" id="unlock">
              <span class="icon"><i class="fas fa-unlock" aria-hidden="true"></i></span>
              <span>Unlock Motors</span>
            </a>
            <a class="button is-primary" id="zero">
              <span class="icon"><i class="fab fa-creative-commons-zero" aria-hidden="true"></i></span>
              <span>Zero</span>
            </a>
          </fieldset>

          <fieldset id="scratch">
            <legend>Scratch API / Turtle Control</legend>
            <button type="move" direction="left" amount="90" title="Turn left 90 degrees">&#8624;</button>
            <button type="move" direction="forward" amount="10" title="Move forward 10">&#8593;</button>
            <button type="move" direction="forward" amount="100" title="Move forward 100">&#8607;</button>
            <button type="move" direction="right" amount="90" title="Turn right 90 degrees">&#8625;</button>
            <turtle title="Turtle angle">&#10140;</turtle>
          </fieldset>

          <fieldset id="heightbuttons">
            <legend>Z/Servo Control</legend>
            <div>
              <label for="skipbufferz">Bypass buffer</label>
              <input id="skipbufferz" type="checkbox">
            </div>
          </fieldset>

        </div>
        <div class="tab-content" data-content="2"><!-- Advanced -->

          <label class="label">Select an SVG file:</label>
          <div class="field has-addons has-addons">
            <div class="control">
              <input class="input" type="file" id="svgfile">
            </div>
            <div class="control">
              <button id="plotstart" class="button is-primary" disabled="disabled">
                <span>Plot Selected File</span>
                <span class="icon is-small">
                  <i class="fa fa-print"></i>
                </span>
              </button>
            </div>
          </div>
          <div class="field is-grouped">
            <p class="control">
              <button class="button is-success" id="forceready">Force Ready State</button>
            </p>
            <p class="control">
              <button id="plotend" class="button is-light is-danger is-outlined">CANCEL</button>
            </p>
          </div>
        </div>
        <div class="tab-content" data-content="3"><!-- Settings -->
          SETTINGS
        </div>
        <div class="tab-content" data-content="4"><!-- Diagnostics -->

          <legend>Composite Functions</legend>
          <button class="button" id="diagtest">Run Diag Test</button>
          <button class="button" id="ruler">Draw Ruler</button>

        </div>
      </div>


    </section>


    <section class="column is-half">
      <canvas class="simcanvas" id="paper"></canvas>
    </section>

    <section class="column">
      <div class="box">
        <label class="subtitle is-4 is-bold">Current Status</label>
        <progress class="progress is-primary is-large" value="0" max="100"></progress>
        <div class="subtitle has-text-centered has-text-dark" id="status"></div>
      </div>
    </section>
  </div>


  <fieldset id="bot"><legend>Live Status</legend>
    <div id="simwrap">
      <canvas class="simcanvas" id="drawarea"></canvas>
      <canvas class="simcanvas" id="bufferarea"></canvas>
    </div>
    <textarea id="pendata"></textarea>
    <fieldset><legend>Buffer</legend>
      <select size="10" id="buffer"></select>
      <div><label for="bufrun">Running: </label><b id="bufrun">false</b></div>
      <div><label for="bufpause">Paused: </label><b id="bufpause">false</b></div>
      <div><label for="bufcount">Items: </label><b id="bufcount">0</b></div>
      <button id="buf_pause">Pause Buffer</button>
      <button id="buf_resume">Resume Buffer</button>
      <button id="buf_clear">Clear Buffer</button>
    </fieldset>
  </fieldset>


<script>
  var socket = io();
  var runningTest = false;
  var $draw = $('#drawarea');
  var pen = {};
  var lastPen = {};
  var resumePen = null;
  var buffer = {};
  var drawPoints = []; // Array of points from buffer to draw

  var viewScale = 1; // The scale to adjust bot steps by for viewing
  var viewMax = {x: 600, y: 400}; // The maximum view size to constrain to

  // Paper and canvas vars.
  var crosshair;
  var crosshairTip;
  var workarea;
  var layers = {};



  // Initialize CNC Server connection details
  // (thanks to CORS support, this should be fully portable)
  cncserver.api.server = {
    domain: document.domain,
    port: location.port ? location.port : 80,
    protocol: 'http',
    version: '1'
  };

  // Manage control tabs.
  $('.tabs li').on('click', function () {
    const $item = $(this);
    const $content = $item.parents('.tabs').next();
    const tab = $item.data('tab');

    $item.siblings('li').removeClass('is-active');
    $item.addClass('is-active');

    $content.find('.tab-content').removeClass('is-active');
    $(`.tab-content[data-content="${tab}"]`).addClass('is-active');
  });



  // Socket.io stream data events =========================
  socket.on('pen update', function(data){
    var animPen = {};
    pen = $.extend({}, data);
    var d = "Status =-=-=-=" + "\n";
    d+= 'draw pos: ' + pen.state + '/' + pen.height + "\n";
    d+= 'tool: ' + pen.tool + "\n";
    $('#pendata').text(d);

    if (pen.lastDuration > 250) {
      animPen = $.extend({}, lastPen);
      if (typeof lastPen.x !== 'undefined') {
        $(lastPen).animate({ x:pen.x, y: pen.y  }, {
          duration: pen.lastDuration - 5,
          easing: 'linear',
          step: function(val, fx) {
            animPen[fx.prop] = val;
            drawUpdate(animPen, pen);
          }
        });
      }
    } else {
      $(lastPen).stop();
      drawUpdate(pen);
      lastPen = $.extend({}, pen);
    }
  });


  // CNCServer Buffer Change events (for pause, update, or resume)
  socket.on('buffer update', function(b){
    // What KIND of buffer update is this?
    switch (b.type) {
      case 'complete':
        buffer = {
          data: b.bufferData,
          list: b.bufferList
        };
      case 'vars':
        $('#bufrun').text(b.bufferRunning);
        $('#bufpause').text(b.bufferPaused);
        resumePen = b.bufferPausePen;
        break;
      case 'add':
        buffer.list.unshift(b.hash);
        buffer.data[b.hash] = b.item;
        break;
      case 'remove':
        var hash = buffer.list.pop();
        delete buffer.data[hash];
        break;
    }

    $('#bufcount').text(buffer.list.length);

    // Populate buffer list of items
    var $b = $('#buffer');
    $b.find('option').remove();
    drawPoints = [];

    for (var i in buffer.list) {
      var cmd = buffer.data[buffer.list[i]].command;

      // Skip the command if it's null
      if (cmd === null) continue;

      if (typeof cmd == "function") cmd = 'callback';

      if (typeof cmd == 'object') {
        if (typeof cmd.type == "string") {
          switch (cmd.type) {
            case 'absmove':
              drawPoints.push({x: cmd.x * viewScale, y: cmd.y * viewScale});
              cmd = 'move: X' + cmd.x + ' Y' + cmd.y;
              break;
            case 'absheight':
              cmd = 'height: ' + cmd.z + ', state:' + cmd.state;
              break;
            case 'message':
              cmd = 'message: ' + cmd.message;
              break;
            case 'callbackname':
              cmd = 'callback: ' + cmd.name;
              break;
            default:
              cmd = cmd.type;
          }
        }
      }

      $b.prepend( $('<option>').text(cmd) );
    }

    var ctx = $('#bufferarea')[0].getContext('2d');

    // Clear it out
    ctx.clearRect(0, 0, $('#bufferarea')[0].width, $('#bufferarea')[0].height);

    // Do we have a resume point? draw that
    if (resumePen) {
      drawCrosshair(ctx, 20, 'green', resumePen);
    }

    // Move points in the buffer? Connect the dots.
    if (drawPoints.length) {
      ctx.beginPath();
      ctx.lineWidth = '4';
      ctx.strokeStyle = "orange";

      // Move to start of buffer (either resume pos, or current)
      if (resumePen) {
        ctx.moveTo(resumePen.x * viewScale, resumePen.y * viewScale);
      } else {
        ctx.moveTo(pen.x * viewScale, pen.y * viewScale);
      }

      for (var i = drawPoints.length - 1; i >= 0; i--) {
        ctx.lineTo(drawPoints[i].x, drawPoints[i].y);
      }

      ctx.stroke();
      ctx.closePath;
    }
  });


  // Setup live display box, pull in the bot specific settings
  cncserver.api.settings.bot().then((response) => {
    const { data: bot } = response;

    $('#bot legend:first').text('Live Status: ' + bot.name);

    // Set subtitle text.
    cncserver.api.settings.global().then((global) => {
      $('.hero-body p.subtitle').text(
        `Controlling ${bot.name} through ${global.data.serialPath} on ${cncserver.api.server.domain}.`
      );
    });

    console.dir(bot);

    // Find the view scale
    if (bot.maxArea.width > bot.maxArea.height) {
      viewScale = viewMax.x / bot.maxArea.width;
    }else {
      viewScale = viewMax.y / bot.maxArea.height;
    }

    // Set the scale and setup paper.
    paper.setup($('#paper')[0]);
    paper.project.view.viewSize = [bot.maxArea.width * viewScale, bot.maxArea.height * viewScale];
    paper.project.view.scale(viewScale, [0, 0]);

    // Setup 3 layers: Drawing, moving, and overlay.
    layers.drawing = new paper.Layer([]);
    layers.moving = new paper.Layer([]);
    layers.overlay = new paper.Layer([]);

    // Make crosshair (on active overlay layer).
    var size = 250;
    crosshair = new paper.Group([
      new paper.Shape.Circle([0, 0], size),
      new paper.Path.Line([-size * 1.5, 0], [-size / 5, 0]),
      new paper.Path.Line([size * 1.5, 0], [size / 5, 0]),
      new paper.Path.Line([0, -size * 1.5], [0, -size / 5]),
      new paper.Path.Line([0, size * 1.5], [0, size / 5]),
    ]);
    crosshair.strokeColor = 'black';
    crosshair.strokeWidth = 40;

    crosshairTip = crosshair.clone();
    crosshairTip.strokeColor = 'green';
    crosshairTip.strokeWidth = 80;
    crosshairTip.sendToBack();

    // Show workarea
    workarea = new paper.Path.Rectangle(
      [bot.workArea.left, bot.workArea.top],
      [bot.maxArea.width, bot.maxArea.height],
    );
    workarea.strokeWidth = 20;
    workarea.strokeColor = 'red';

    // Setup the height option buttons for the bot
    for (var name in bot.servo.presets) {
      $('#heightbuttons').append(
        $('<button>').text(name).click(function(){
          cncserver.api.pen.height($(this).text(), null, {
            skipBuffer: $('#skipbufferz').prop('checked') ? 1 : ''
          });
        })
      );
    }

    // Initially set the pen from the bot
    cncserver.api.pen.stat().then((response) => {
      pen = response.data;
      lastPen = $.extend({}, response.data);
      drawUpdate(response.data);
    });
  });


  function drawUpdate(current, dest) {
    console.log('UPDATE', current, dest);

    // Draw directional path to DEST
    if (dest) {
      crosshairTip.position = [dest.x, dest.y];
    }

    crosshair.position = [current.x, current.y];
  };

  var run = cncserver.cmd.run; // Shortcut!

  function drawUpdate(current, dest) {

  }

  // Bind button action click
  $('button').click(function(){
    var $this = $(this);

    // Bind special for scratch buttons, as they're not regular API things.
    if ($this.parent().is('#scratch')) {
      cncserver.api.scratch.move(
        $this.attr('direction'),
        $this.attr('amount'),
        function(d) {
          $('#scratch turtle').css('transform', 'rotate(' + (parseInt(d.angle)-90) + 'deg)');
        }
      );
      return;
    }

    // Bind for normal API functionality buttons.
    var id = this.id;
    switch(id) {
      case 'diagtest':
        runningTest = !runningTest;
        if (!runningTest) {
          $(this).text('Run Diag Test');
          cncserver.cmd.clear();
          run('park');
        } else {
          $(this).text('STOP Diag Test');
          runTest();
        }

        break;
      case 'buf_pause':
        cncserver.api.buffer.pause();
        break;
      case 'buf_resume':
        cncserver.api.buffer.resume();
        break;
      case 'buf_clear':
        cncserver.api.buffer.clear();
        break;
      case 'unlock':
        cncserver.api.motors.unlock();
        break;
      case 'zero':
        cncserver.api.pen.zero();
        break;
      case 'park':
        cncserver.api.pen.park(null, {
          skipBuffer: $('#skipbuffer').prop('checked') ? 1 : ''
        }); // << Direct method
        break;
    }

    // One of the move button array
    if ($(this).is('.move')) {
      var pos = $(this).text().split(',');
      cncserver.api.pen.move({
        x: pos[0],
        y: pos[1],
        skipBuffer: $('#skipbuffer').prop('checked') ? 1 : ''
      });
    }
  });

  // Populate tool buttons
  cncserver.api.tools.list().then((response) => {
    if (response.data) {
      $('#tools h4').remove();
      for (var i in response.data.tools) {
        $('<p>')
          .addClass('control')
          .append(
            $('<button>')
              .text(response.data.tools[i])
              .addClass('button is-info is-small')
          )
          .appendTo('#tools');
      }
      $('#tools button').click(function(){
        cncserver.api.tools.change($(this).text());
      });
    } else {
      $('#tools h4').text('Failed to load tools :(');
    }
  });

  // Test runner function
  function runTest(){
    run('move', {x:75,y:75});
    run('move', {x:65,y:0});
    run('move', {x:75,y:100});
    run('move', {x:100,y:0});
    run('move', {x:0,y:100});
    run('move', {x:0,y:0});
    run('move', {x:100,y:100});
    run('park');
    run('custom', runTest);
  }

  function drawRuler(){
    var pos = {x: 0, y: 70};
    var border = 3; // 3mm border from edge.
    var width = 20 * 10; // N cm ruler.
    var height = 30; // 30mm high.
    var tickSizes = [2.5, 5, 8.25]; // Ticks at 2.5, 5 and 8.25 mm height.

    // Draw ruler border.
    run('move', {x:pos.x, y:pos.y, abs: 'mm'}); // Top left
    run('down'); // Draw.
    run('move', {x:pos.x + width + border * 2, y: pos.y, abs: 'mm'}); // Top right
    run('move', {x:pos.x + width + border * 2, y: pos.y + height, abs: 'mm'}); // Bottom right
    run('move', {x:pos.x, y:pos.y + height, abs: 'mm'}); // Bottom left
    run('move', {x:pos.x, y:pos.y, abs: 'mm'}); // Top left
    run('up');

    // Loop over X positions from left to right.
    for (var x = 0; x <= width; x++) {
      var drawX = pos.x + border + x;

      var hIndex = 0; // Default to small tick.
      if (x % 5 === 0) {
        hIndex = x % 10 === 0 ? 2 : 1;
      }

      // Skip small ticks!
      if (hIndex != 0) {
        run('move', {x: drawX, y:pos.y, abs: 'mm'}); // Top of X pos
        run('down');
        run('move', {x: drawX, y: pos.y + tickSizes[hIndex], abs: 'mm'}); // Top of X pos
        run('up');
      }
    }
    run('park');
  }


  function drawRulerVert(){
    var pos = {x: 180, y: 0};
    var border = 3; // 3mm border from edge.
    var width = 19 * 10; // N cm ruler.
    var height = 30; // 30mm high.
    var tickSizes = [2.5, 5, 8.25]; // Ticks at 2.5, 5 and 8.25 mm height.

    // Draw ruler border.
    run('move', {x:pos.x, y:pos.y, abs: 'mm'}); // Top left
    run('down'); // Draw.
    run('move', {x:pos.x + height, y: pos.y, abs: 'mm'}); // Top right
    run('move', {x:pos.x + height, y: pos.y + width + border * 2, abs: 'mm'}); // Bottom right
    run('move', {x:pos.x, y:pos.y + width + border * 2, abs: 'mm'}); // Bottom left
    run('move', {x:pos.x, y:pos.y, abs: 'mm'}); // Top left
    run('up');

    // Loop over Y positions from top to bottom.
    for (var y = 0; y <= width; y++) {
      var drawY = pos.y + border + y;

      var hIndex = 0; // Default to small tick.
      if (y % 5 === 0) {
        hIndex = y % 10 === 0 ? 2 : 1;
      }

      // Skip small ticks!
      if (hIndex != 0) {
        run('move', {x: pos.x, y: drawY, abs: 'mm'});
        run('down');
        run('move', {x: pos.x + tickSizes[hIndex], y: drawY, abs: 'mm'});
        run('up');
      }
    }
    run('park');
  }

</script>


</body>
</html>
